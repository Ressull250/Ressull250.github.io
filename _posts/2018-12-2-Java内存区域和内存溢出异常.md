---
layout:     post
title:      JVM-内存区域和内存溢出异常
subtitle:   
date:       2018-12-2
author:     LiaoBo
header-img: img/header_02.jpg
catalog: true
tags:
    - Java
---

### 2.2  Java运行时数据区



![Java运行时数据区]({{site.url}}/postimgs/RuntimeDataArea.png)

- 其中**方法区（Non-heap）**和**堆**是由所有**线程共享**的数据区

- **Java堆**（Java Heap）

  - 堆是Java虚拟机所管理的内存中最大的一块。是被所有的线程共享的一块内存区域，在虚拟机启动时创建。
  - 此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在此分配内存。由于JIT编译器的发展与逃逸分析技术的发展，栈上分配、标量替换优化技术的进步，所有的对象实例都分配在堆上也不是那么绝对了。 

  - *Java堆是垃圾收集器管理的主要区域*，因此也被称为“GC堆”（Garbage Collection Heap）。现在的收集器都是采用分代收集算法，所以Java堆中可以细分为：新生代和老生代。

  - 根据Java虚拟机规范，Java堆可以是处于物理上不连续的内存空间中，只要逻辑上连续即可。在实现上可以是固定大小，也可以是可扩展的，主流的是可扩展方式。

- **方法区**（Method Area）

  - 方法区与Java堆一样，都是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态常量、即时编译器编译后的代码等数据。
  - **运行常量池**是方法区的一部分
    - Class文件除了有类的版本、字段、方法、接口等描述信息，还有一项信息就是常量池，用于存放编译时期生成的各种字面量和符号引用，这部分内容将在类加载后存放到方法区的运行时常量池。-
    - 运行时常量池相对于Class文件常量池的另外一个重要特征是**具备动态性**，Java语言并不要求常量一定只能在编译期产生，也就是并非预置入Class文件中常量池的内容才能进入方法区运行时常量池，运行期间也可能将将新的常量放入池中，这种特性被开发人员利用的比较多的便是String类的intern()方法。



### 2.3 对象揭秘

- 对象的创建
  - 类加载检查：检查该对象的类是否已经被加载、解析、初始化过，如果没有则先进行类加载操作。
  - 分配内存：
    - 如果内存规整使用“指针碰撞”分配，否则一般使用“空闲列表”分配，具体看垃圾回收器是否带有整理（Compact）空闲内存功能。
    - 并发分配内存空间的解决方案：
      - CAS配上失败重试的方式保证更新操作的原子性(?)
      - 本地线程分配缓冲（Thread Local Allocation Buffer, **TLAB**），没个类在java堆中预先分配一小块内存，只用TLAB用完并分配新的TLAB才需要同步锁定。可通过参数`-XX:+/-UseTLAB`设定
  - 初始化：将内存区初始化置零，若设置了TLAB
    对象头设置：这个对象是哪个类的实例、如何找到类的元数据信息、哈希码、GC分代年龄信息等即为对象头
  - 从虚拟机角度对象已经创建了，但从java程序的角度，\<init>方法还没用执行



- 对象内存布局

  - 对象头： 

    - 一部分称为Mark Word，包含哈希码、GC分代年龄、锁状态标志等，采用压缩存储，压缩到虚拟机位数（32位/64位） 

    - 另一部分为类型指针，指向它的类元数据，用于对象的访问定位，非必需，看虚拟机的具体实现。

  - 实例数据：具体其成员字段的内容，包含父类（一般靠前）及自己的。

  - 对齐填充：非必需只有前两者加起来非8的倍数时才会有。



- 对象的访问定位

  - 通过句柄访问对象：当java虚拟机GC移动堆对象时，并不需要修改reference，只需修改句柄对象的实例数据指针。

    ![通过句柄访问对象]({{site.url}}/postimgs/reference.png)

  - 通过直接指针访问对象：加快了对象访问速度，比间接访问少一次对象实例数据的访问，HotSpot则采用的这种访问方式。



### 2.4 OutOfMemoryError异常

- java堆溢出
  - `-Xms20m -Xmx50m` 堆最小值，最大值
  - 参数设置一样即可避免堆自动扩展

- 栈溢出
  - `-Xss128k `栈容量
  - 栈溢出异常和扩展栈无法申请到内存本质是对同一件事情的不同表述

- 方法区溢出
  - `-XX:PermSize -XX:MaxPermSize` 限制方法区大小

- 直接内存溢出
  - `-XX:MaxDirectMemorySize` 指定，如果不指定，默认与堆最大值相同