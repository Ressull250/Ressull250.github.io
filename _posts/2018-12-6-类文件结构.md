---
layout:     post
title:      JVM-类文件结构
subtitle:   
date:       2018-12-6
author:     LiaoBo
header-img: img/header_02.jpg
catalog: true
tags:
    - Java
---
> 这章讲Class文件内容比较多也比较干，用的时候再查



### 6.2 平台无关性

实现无关性的基石是虚拟机和字节码储存格式



### 6.3 Class类文件的结构

- Class文件是**一组以8位字节为基础单位的二进制流**，各个数据项目严格按照顺序紧凑地排列在Class文件中，中间没有添加任何分隔符。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。

- 按照Java虚拟机规范，Class文件格式采用一种类似于C语言结构体的伪结构来存储，这种结构中只有两种数据类型：**无符号数**和**表**。

  - **无符号数**属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节、和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值、或者按照UTF-8编码构成字符串值。

  - **表**是由多个无符号数或其他表作为数据项构成的复合数据类型，所有的表都习惯性地以```"_info"```结尾。表用于描述有层次关系的复合数据结构的数据，整个Class文件本质上就是一张表。

- 结构：
  - **魔数**：
    - 0xCAFEBABE
  - **版本号**：
    - 紧挨着魔数的4个字节存储的是Class文件的版本号：第5和6个字节是次版本号（Minor Version），第7和8个字节是主版本号（Major Version）。
  - **常量池**：
    - 它是Class文件中与其它项目关联最紧密的数据类型，也是占用Class文件空间最大的数据项目之一，同时还是Class文件中第一个出现的表类型数据项目。
    - 常量池中主要存放两大类常量：字面量（Literal）和符号引用（Symbolic Reference）。字面量比较接近Java语言的常量概念，如文本字符串、被声明为final的常量值等。而符号引用则属于编译原理方面的概念，包括了下面三类常量：
      - 类和接口的全限定名（Fully Quaified Name）
      - 字段的名称和描述
      - 方法的名称和描述符
  - **访问标志**：
    - 用于识别一些类或接口层次的访问信息，包括：这个Class是类还是接口，是否定义为public类型，是否定义为abstract类型，如果是类的话，是否被声明为final，等等。
  - **类索引、父类索引、接口索引集合**：
    - 类索引（this_class）和父类索引（super_class）都是一个u2类型的数据，而接口索引集合是**一组**u2类型的数据集合，class文件由这三个数据来确定这个类的继承关系。
    - 类的全限定名，父类的全限定名，一组实现接口的限定名
  - **字段表集合：**
    - 用于描述类或者接口的声明的变量，类级变量和实例级变量，不包括方法的内部声明变量。
    - Java中一个字段（field）可以包含的信息包括：字段的作用域（public、private、protected）、类级别还是实例级别（static）、可变性（final）、并发可见性（volatile是否强制从主内存读写）、可否序列化（transient）、字段数据类型（基本类型、对象、数组）、名称。
    - 描述符的概念：P177
  - **方法表集合：**
    - 结构如同字段表集合一样，包括了访问标识（access_flag）、名称索引（name_index）、描述符索引（descriptor_index）、属性表集合（attributes）
    - 方法的字节码存在于名为Code的属性表中
  - **属性表集合：**
    - 用于描述某些场景（Class文件、字段表、方法表）的专有信息。
    - 一堆属性表：
      - Code属性，放方法字节码
      - Exceptions属性
      - ...



### 6.4 字节码指令

很多很杂，不过命名方式基本和汇编差不多，通过名字猜测，用的时候翻书